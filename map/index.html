
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
	<title>Document</title>
	<style>
html{height:100%}
body{height:100%;margin:0px;padding:0px}
#container{height:100%}

#searchBox{
	position: absolute;
	width: 70%;
	top: 2%;
	left: 10%;
	z-index: 10;
}
	/*去除百度地图版权*/
	.BMap_cpyCtrl{display: none!important;}/*隐藏百度地图版权*/
/*	.anchorBL{
		display:none;
		}*/

 .bg-container{
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
background: rgba(238, 238, 238,0.5);
display: none
 }
 .dg-container{ width: 100%; height: 450px; position: absolute; margin:auto; top:0;  bottom:0; z-index: 1000; }

.dg-wrapper{
    width: 481px;
    height: 316px;
    margin: 0 auto;
    position: relative;

}
.dg-wrapper a{
/*    width: 482px;
    height: 316px;*/
    width: 316px;
    height: 482px;
    margin: 0 83px;
    display: block;
    position: absolute;
    left: 0;
    top: 0;


 border-radius: 10px;
    box-shadow: 0px 10px 20px rgba(0,0,0,0.3);
}

.dg-wrapper a img{
    display: block;

/*width: 482px;
height: 316px;*/
width: 316px;
height: 482px;

border-radius: 10px;

}


.dg-container nav{
    width: 150px;
    position: absolute;
    z-index: 1000;
    bottom: -80px;
    left: 49%;
    margin-left: -29px;
}
.dg-container nav span{
    text-indent: -9000px;
    float: left;
    cursor:pointer;
    width: 30px;
    height: 30px;
    opacity: 0.8;
    background: transparent url(images/icon.png) no-repeat top left;
}
.dg-container nav span:hover{
    opacity: 1;
}

.dg-container nav span.close {
   background-position: -60px 0px;
    margin-left: 10px;
    float: left;
}



}
	</style>


     <script src="http://cdn.bootcss.com/jquery/3.2.0/jquery.min.js"></script>

    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=iWKEGdsj2orvnolSOfF9d1qQ9EpHiumn"></script>
    <script src="http://api.map.baidu.com/library/SearchControl/1.4/src/SearchControl.js"></script>
    <script src="http://api.map.baidu.com/library/RichMarker/1.2/src/RichMarker.js"></script>
	<link rel="stylesheet" href="http://api.map.baidu.com/library/SearchControl/1.4/src/SearchControl_min.css">

</head>
<body>
        <input type="file" class="file" style="display: none">
        <input type="file" class="file1" style="display: none">
        <div class="bg-container">
            <section id="dg-container" class="dg-container">
                <div class="dg-wrapper">
                    <a href="#"><img src="images/ee.png" alt="image01"></a>
                </div>
                <nav>

                    <span class="close" onclick="closeBg()"></span>

                </nav>
            </section>
        </div>

	<div id="searchBox"></div>
	<div id="container">
	</div>


</body>
<script type="text/javascript">

function readAsDataURL(){

}

function closeBg(){
     document.getElementsByClassName('bg-container')[0].style.display = 'none';
}
//创建和初始化地图函数：
function initMap() {
    createMap();//创建地图
    setMapEvent();//设置地图事件
    addMapControl();//向地图添加控件

    jianting();//监听回车


}


//创建地图函数：
function createMap() {
    var map = new BMap.Map("container",{enableMapClick:false});//在百度地图容器中创建一个地图,关闭poi ,{enableMapClick:false}
    var point = new BMap.Point(104.072366,30.664789);//定义一个中心点坐标
    map.centerAndZoom(point, 12);//设定地图的中心点和坐标并将地图显示在地图容器中

    window.map = map;//将map变量存储在全局
}

//地图事件设置函数：
function setMapEvent() {

    map.enableDragging();//启用地图拖拽事件，默认启用(可不写)
    map.enableScrollWheelZoom();//启用地图滚轮放大缩小
    map.enableDoubleClickZoom();//启用鼠标双击放大，默认启用(可不写)
    map.enableKeyboard();//启用键盘上下左右键移动地图
}

//地图控件添加函数：
function addMapControl() {
    //向地图中添加缩放控件
    // var ctrl_nav = new BMap.NavigationControl( {
    //     anchor : BMAP_ANCHOR_TOP_LEFT,
    //     type : BMAP_NAVIGATION_CONTROL_LARGE
    // });
    // // 创建鱼骨控件
    // map.addControl(ctrl_nav);
    // //向地图中添加缩略图控件
    // var ctrl_ove = new BMap.OverviewMapControl( {
    //     anchor : BMAP_ANCHOR_BOTTOM_RIGHT,
    //     isOpen : 1
    // });
    // map.addControl(ctrl_ove);
    // //向地图中添加比例尺控件
    // var ctrl_sca = new BMap.ScaleControl( {
    //     anchor : BMAP_ANCHOR_BOTTOM_LEFT
    // });
    // map.addControl(ctrl_sca);
    //向地图中添加地图类型控件
    var MapType = new BMap.MapTypeControl({
        anchor : BMAP_ANCHOR_TOP_RIGHT
    });
    map.addControl(MapType);
    //检索类型
	var type = "";
	type = LOCAL_SEARCH ;   //周边检索
	//type = TRANSIT_ROUTE; //公交检索
	//type = DRIVING_ROUTE; //驾车检索
	//创建检索控件
	var searchControl = new BMapLib.SearchControl({
    	container : "searchBox" //存放检索控件的容器
    	, map     : map          //检索的关联地图
    	, type    : type        //检索类型
	});
}


 function jianting(){ document.getElementById('BMapLib_PoiSearch').onkeydown=keyDownSearch;
    function keyDownSearch(e) {
        // 兼容FF和IE和Opera
        var theEvent = e || window.event;
        var code = theEvent.keyCode || theEvent.which || theEvent.charCode;
        if (code == 13) {
           document.getElementById('BMapLib_sc_b0').click();
            return false;
        }
        return true;
    }
}

function addRichMarker(x,y,menuType){

    var count =storage.getItem('count')?storage.getItem('count'):0;
 //检验是否为图像文件
    if (menuType == 1) {
        var file = document.getElementsByClassName("file")[0].files[0];
    }else if(menuType == 2){
        var file = document.getElementsByClassName("file1")[0].files[0];
    }
    if(!/image\/\w+/.test(file.type)){
        alert("请上传图片噢！");
        return false;
    }
    var reader = new FileReader();
    //将文件以Data URL形式读入页面
    reader.readAsDataURL(file);

    reader.onload=function(e){
        // var result=document.getElementById("result");
        // result.innerHTML='<img src="' + this.result +'" alt="" />';

    // var htmll = "images/close.png";
    if(menuType == 1){
        var htm = "<div class='overLay num"+count+"' style='width:65px;height:116px;background:url(images/back5.png) left top no-repeat; position: absolute;z-index: 100'>"
        +"<img src='images/close.png' class='close' style='position:absolute;top: -5px;right: -5px;width:20px;height:20px;display:none'>"
        +"<img class='image1' style='margin-left:10px;margin-top: 13px;width: 47px;height: 75px; border-radius:2px;' src='" + this.result + "' />"
               + "</div>";
        myRichMarker1 = new BMapLib.RichMarker(htm,  new BMap.Point(x,y),{
                                                  "anchor" : new BMap.Size(-33, -116),
                                                  "enableDragging" : false});
        }else if(menuType == 2){

        var htm = "<div class='overLay num"+count+"' style='width:93px;height:77px;background:url(images/back4.png) left top no-repeat; position: absolute;z-index: 100'>"
        +"<img src='images/close.png' class='close' style='position:absolute;top: -5px;right: -5px;width:20px;height:20px;display:none'>"
        +"<img class='image1' style='margin-left:9px;margin-top: 5px;width: 75px;height: 47px; border-radius:2px;' src='" + this.result + "' />"
               + "</div>";
                       myRichMarker1 = new BMapLib.RichMarker(htm,  new BMap.Point(x,y),{
                                                  "anchor" : new BMap.Size(-47, -77),
                                                  "enableDragging" : false});
        }

    map.addOverlay(myRichMarker1);

    var overLay = document.getElementsByClassName("num"+count)[0];

    overLay.addEventListener('mouseover',function(){
        this.getElementsByClassName('close')[0].style.display = 'block';
    });
    overLay.addEventListener('mouseout',function(){
        this.getElementsByClassName('close')[0].style.display = 'none';
    });


    overLay.getElementsByClassName('close')[0].addEventListener('click',function(){

   var overLayClass = $(this).parent()[0].getAttribute('class');
   var coun = overLayClass.replace(/[^0-9]/ig,"");
   var cou = Number(coun);

    storage.removeItem('data'+cou);
    $(this).parent().remove();

    });
    // var markerPoint = myRichMarker1.getPosition();

    overLay.getElementsByClassName('image1')[0].addEventListener('click',function(){
        var overLayClass = $(this).parent()[0].getAttribute('class');
        var coun = overLayClass.replace(/[^0-9]/ig,"");
        var cou = Number(coun);
        var overLayObj = JSON.parse(storage.getItem('data'+cou));
        var richMarker = new BMap.Point(overLayObj.lng,overLayObj.lat);
        var dgCon =document.getElementById('dg-container');
        var aaa = dgCon.getElementsByTagName('a');
        aaa[0].setAttribute("class","dg-center");
        map.panTo(richMarker);
        if(map.getZoom() < 11){
         setTimeout(function(){
         map.setZoom(12);
          }, 1000);  //2秒后放大到14级
        }

    if(y.toFixed(2) == map.getCenter().lat.toFixed(2)){

            if(overLayObj.imgType == 1){
            var dataURL = overLayObj.url;
            var firstImg = dgCon.getElementsByTagName('img')[0];
            firstImg.setAttribute('src',dataURL);
            var a = dgCon.getElementsByTagName('a');
            var nav = dgCon.getElementsByTagName('nav')[0];
            for (var i = 0; i < a.length; i++) {
                    a[i].style.width = "316px";
                    a[i].style.height = "482px";
                    a[i].style.margin = "0 83px";
                    var img = dgCon.getElementsByTagName('img');
                    img[i].style.width = "316px";
                    img[i].style.height = "482px";
                    nav.style.bottom = "-80px";
                }


            }else if(overLayObj.imgType == 2){
            var dataURL = overLayObj.url;
            var firstImg = dgCon.getElementsByTagName('img')[0];
            firstImg.setAttribute('src',dataURL);
            var a = dgCon.getElementsByTagName('a');
            var nav = dgCon.getElementsByTagName('nav')[0];
            for (var i = 0; i < a.length; i++) {
                    a[i].style.width = "482px";
                    a[i].style.height = "316px";
                    a[i].style.margin = "0";
                    var img = dgCon.getElementsByTagName('img');
                     img[i].style.width = "482px";
                     img[i].style.height = "316px";
                     nav.style.bottom = "40px";
                }

            }


            document.getElementsByClassName('bg-container')[0].style.display = 'block';
             }

            });


           var data=[];
           data[count]={
                imgType:menuType,
                lng:x,
                lat:y,
                url:this.result
            };

        var stringObj = JSON.stringify(data[count]);

     storage.setItem("data"+count,stringObj);


++count;
storage.setItem('count',count);


}

}


initMap();//创建和初始化地图
var storage = window.localStorage;



var ttt = new Array;
var menu = new BMap.ContextMenu();

var txtMenuItem = [
    {
        text:'在这添加一张竖着照的照片',
        callback:function(){
            var input = document.getElementsByClassName('file')[0];
             input.click();

             input.addEventListener('change',function(){

                 var menuType = 1;
                 addRichMarker(ttt.lng,ttt.lat,menuType);
                  $('.file').val('');
             })


       }
    },
    {
            text:'在这添加一张横着照的照片',
            callback:function(){
             var input1 = document.getElementsByClassName('file1')[0];
             input1.click();

             input1.addEventListener('change',function(){

                 var menuType = 2;
                 addRichMarker(ttt.lng,ttt.lat,menuType);
                  $('.file1').val('');
             })
            }
    }
];
for(var i=0; i < txtMenuItem.length; i++){
    menu.addItem(new BMap.MenuItem(txtMenuItem[i].text,txtMenuItem[i].callback,100));
}
map.addContextMenu(menu);
map.addEventListener("rightclick", function(e){
        ttt.lng = e.point.lng;
        ttt.lat = e.point.lat;
 });


for (var ii = 0; ii < storage.getItem('count'); ii++) {

         var json = storage.getItem("data"+ii);

         if(!json){

            continue;
         };
        var jsonObj = JSON.parse(json);
        var menuType = jsonObj.imgType;
    if(menuType == 1){
        var htm = "<div class='overLay num"+ii+"' style='width:65px;height:116px;background:url(images/back5.png) left top no-repeat; position: absolute;z-index: 100'>"
        +"<img src='images/close.png' class='close' style='position:absolute;top: -5px;right: -5px;width:20px;height:20px;display:none'>"
        +"<img class='image1' style='margin-left:10px;margin-top: 13px;width: 47px;height: 75px;border-radius:2px;' src='" + jsonObj.url + "' />"
               + "</div>";

    myRichMarker1 = new BMapLib.RichMarker(htm,  new BMap.Point(jsonObj.lng,jsonObj.lat),{
                                                  "anchor" : new BMap.Size(-33, -116),
                                                  "enableDragging" : false});
        }else if(menuType == 2){

        var htm = "<div class='overLay num"+ii+"' style='width:93px;height:77px;background:url(images/back4.png) left top no-repeat; position: absolute;z-index: 100'>"
        +"<img src='images/close.png' class='close' style='position:absolute;top: -5px;right: -5px;width:20px;height:20px;display:none'>"
        +"<img class='image1' style='margin-left:9px;margin-top: 5px;width: 75px;height: 47px; border-radius:2px;' src='" + jsonObj.url + "' />"
               + "</div>";
                       myRichMarker1 = new BMapLib.RichMarker(htm,  new BMap.Point(jsonObj.lng,jsonObj.lat),{
                                                  "anchor" : new BMap.Size(-47, -77),
                                                  "enableDragging" : false});
        }

    map.addOverlay(myRichMarker1);
    var overLay = document.getElementsByClassName("num"+ii)[0];

    overLay.addEventListener('mouseover',function(){
        this.getElementsByClassName('close')[0].style.display = 'block';
    });
    overLay.addEventListener('mouseout',function(){
        this.getElementsByClassName('close')[0].style.display = 'none';
    });
    overLay.getElementsByClassName('close')[0].addEventListener('click',function(){

   var overLayClass = $(this).parent()[0].getAttribute('class');
   var coun = overLayClass.replace(/[^0-9]/ig,"");
   var cou = Number(coun);

    storage.removeItem('data'+cou);
 $(this).parent().remove();

    });

    overLay.getElementsByClassName('image1')[0].addEventListener('click',function(){
        var overLayClass = $(this).parent()[0].getAttribute('class');
        var coun = overLayClass.replace(/[^0-9]/ig,"");
        var cou = Number(coun);
        var overLayObj = JSON.parse(storage.getItem('data'+cou));
        var richMarker = new BMap.Point(overLayObj.lng,overLayObj.lat);
        var dgCon = document.getElementById('dg-container');
        map.panTo(richMarker);
        if(map.getZoom() < 11){
         setTimeout(function(){
         map.setZoom(12);
          }, 1000);  //2秒后放大到14级
        }

         if(richMarker.lat.toFixed(2) == map.getCenter().lat.toFixed(2)){
            var dataURL = overLayObj.url;
            var firstImg = dgCon.getElementsByTagName('img')[0];
            firstImg.setAttribute('src',dataURL);

            var coun = storage.getItem('count');
            var ad = dgCon.getElementsByTagName('a');

        if(overLayObj.imgType == 1){
            var a = dgCon.getElementsByTagName('a');
            var nav = dgCon.getElementsByTagName('nav')[0];
            for (var i = 0; i < a.length; i++) {
                    a[i].style.width = "316px";
                    a[i].style.height = "482px";
                    a[i].style.margin = "0 83px";
                    var img = dgCon.getElementsByTagName('img');

                     img[i].style.width = "316px";
                     img[i].style.height = "482px";


                    nav.style.bottom = "-80px";
                }


            }else if(overLayObj.imgType == 2){

                var a = dgCon.getElementsByTagName('a');
                var nav = dgCon.getElementsByTagName('nav')[0];
                for (var i = 0; i < a.length; i++) {
                    a[i].style.width = "482px";
                    a[i].style.height = "316px";
                    a[i].style.margin = "0";
                    var img = dgCon.getElementsByTagName('img');
                     img[i].style.width = "482px";
                     img[i].style.height = "316px";
                    nav.style.bottom = "40px";
                }

            }
            document.getElementsByClassName('bg-container')[0].style.display = 'block';
         };
    });

}




</script>


</html>
